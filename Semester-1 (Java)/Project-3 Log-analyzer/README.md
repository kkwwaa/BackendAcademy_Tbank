# Проект №3 "Анализатор логов"

## 2. Функциональные требования

### 1. Интерфейс программы

- [ ] CLI
  - [ ] Поддержка удаленных и локальных путей, списка в формате `.txt`, `.log`
  - [ ] Ошибка если: неподдерживаемый формат, не найден файл по пути
  - 
- [ ] Поддержка формата вывода: `json`, `markdown`,`adoc`
- [ ] Ошибка если: неподдерживаемый формат
- [ ] Поддержка путь до файла для сохранения результата
- [ ] Ошибка если: файл по пути уже сущ-ет, дир-ия недоступна, расширение не соот-ет ожид-му
- [ ] Поддержка параметра с датами в формате **ISO8601**
- [ ] Ошибка если: `from >= to`, не соот-ие формату
- [ ] Поддержка всех комбинаций пар-ров

- [ ] Парсинг логов
- [ ] Валидация форматов - WARN & SKIP

- [ ] Статистика:
  - [ ] общее количество запросов
  - [ ] средний и максимальный размер ответа от сервера
  - [ ] 95% перцентиль размера ответа от сервера
  - [ ] частота встречаемых кодов ответа
  - [ ] топ-10 наиболее часто запрашиваемых ресурсов, отсортированных по убыванию
  - [ ] распределение запросов по датам в процентом соотношении от общего числа **(+доп. баллы)**
  - [ ] уникальные используемые протоколы передачи данных (HTTP/1, HTTP/2, etc) **(+доп. баллы)**
  - [ ] Точность результатов при расчёте статистики должна быть **2 знака после запятой**.

- [ ] Собранная статистика должна быть сохранена по указанному пути в выбранном пользователем формате. 

Поэтому, любое исключение в приложении должно транслироваться в соответсвующий код возврата:

- `0` - программа успешно завершила свою работу
- `1` - непредвиденная ошибка
- `2` - некорректное использование программы (неверные параметры, отсутствие файлов и т.д.)

**Пример запуска программы:**

```shell
java -jar log-analyzer.jar --path logs/*.log --format markdown --output report.md --from 2025-03-01
```

### 2. Формат обрабатываемых данных

Программа должна быть способна обрабатывать логи NGINX-сервера в приведенном ниже формате. В случае, если
по какой-то причине строка не соответсвует данному формату, данная непредвиденная ситуация должна быть залогирована с
уровнем логирования WARN, а сама строка - пропущена.

```
'$remote_addr - $remote_user [$time_local] ' '"$request" $status $body_bytes_sent ' '"$http_referer" "$http_user_agent"'
```

Примеры логов:

```
93.180.71.3 - - [17/May/2015:08:05:32 +0000] "GET /downloads/product_1 HTTP/1.1" 304 0 "-" "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.21)"
93.180.71.3 - - [17/May/2015:08:05:23 +0000] "GET /downloads/product_1 HTTP/1.1" 304 0 "-" "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.21)"
```

Еще больше примеров можно
найти [здесь](https://raw.githubusercontent.com/elastic/examples/master/Common%20Data%20Formats/nginx_logs/nginx_logs).

### 4. Вывод программы

Собранная статистика должна быть сохранена по указанному пути в выбранном пользователем формате.

В случае, если пользователь выбрал формат `json`, результат работы программы должен быть записан
в соответствии со следующей JSON-схемой:

```json
{
    "$schema": "http://json-schema.org/draft-04/schema#",
    "type": "object",
    "properties": {
        "files": {
            "type": "array",
            "items": [
                {
                    "type": "string"
                }
            ]
        },
        "totalRequestsCount": {
            "type": "integer"
        },
        "responseSizeInBytes": {
            "type": "object",
            "properties": {
                "average": {
                    "type": "number",
                    "multipleOf": 0.01
                },
                "max": {
                    "type": "number",
                    "multipleOf": 0.01
                },
                "p95": {
                    "type": "number",
                    "multipleOf": 0.01
                }
            },
            "required": [
                "average",
                "max",
                "p95"
            ]
        },
        "resources": {
            "type": "array",
            "items": [
                {
                    "type": "object",
                    "properties": {
                        "resource": {
                            "type": "string"
                        },
                        "totalRequestsCount": {
                            "type": "integer"
                        }
                    },
                    "required": [
                        "resource",
                        "totalRequestsCount"
                    ]
                }
            ]
        },
        "responseCodes": {
            "type": "array",
            "items": [
                {
                    "type": "object",
                    "properties": {
                        "code": {
                            "type": "integer"
                        },
                        "totalResponsesCount": {
                            "type": "integer"
                        }
                    },
                    "required": [
                        "code",
                        "totalResponsesCount"
                    ]
                }
            ]
        },
        "requestsPerDate": {
            "type": "array",
            "items": [
                {
                    "type": "object",
                    "properties": {
                        "date": {
                            "type": "string"
                        },
                        "weekday": {
                            "type": "string"
                        },
                        "totalRequestsCount": {
                            "type": "integer"
                        },
                        "totalRequestsPercentage": {
                            "type": "number",
                            "multipleOf": 0.01
                        }
                    },
                    "required": [
                        "date",
                        "weekday",
                        "totalRequestsCount",
                        "totalRequestsPercentage"
                    ]
                }
            ]
        },
        "uniqueProtocols": {
            "type": "array",
            "items": [
                {
                    "type": "string"
                }
            ]
        }
    },
    "required": [
        "files",
        "totalRequestsCount",
        "responseSizeInBytes",
        "resources",
        "responseCodes"
    ]
}
```

Для всех остальных форматов никаких дополнительных требований к выводу данных нет.

Пример вывода в формате `json`:

```json
{
    "files": [
        "access.log",
        "http://example.com/access.log"
    ],
    "totalRequestsCount": 10000,
    "responseSizeInBytes": {
        "average": 500,
        "max": 1000,
        "p95": 950
    },
    "resources": [
        {
            "resource": "/downloads/product_1",
            "totalRequestsCount": 1000
        },
        {
            "resource": "/downloads/product_2",
            "totalRequestsCount": 100
        }
    ],
    "responseCodes": [
        {
            "code": 500,
            "totalResponsesCount": 1
        },
        {
            "code": 401,
            "totalResponsesCount": 10
        },
        {
            "code": 200,
            "totalResponsesCount": 1000
        }
    ],
    "requestsPerDate": [
        {
            "date": "2024-03-01",
            "weekday": "Monday",
            "totalRequestsCount": 2981,
            "totalRequestsPercentage": 12.10
        }
    ],
    "uniqueProtocols": [
        "HTTP/1.1",
        "HTTP/2.0",
        "grpc"
    ]
}
```

Пример вывода в формате `markdown`:

```markdown
#### Общая информация

|        Метрика        |     Значение |
|:---------------------:|-------------:|
|       Файл(-ы)        | `access.log` |
|    Начальная дата     |   31.08.2024 |
|     Конечная дата     |            - |
|  Количество запросов  |       10_000 |
| Средний размер ответа |         500b |
|  95p размера ответа   |         950b |

#### Запрашиваемые ресурсы

|     Ресурс      | Количество |
|:---------------:|-----------:|
|  `/index.html`  |      5_000 |
|  `/about.html`  |      2_000 |
| `/contact.html` |      1_000 |

#### Коды ответа

| Код |          Имя          | Количество |
|:---:|:---------------------:|-----------:|
| 200 |          OK           |       8000 |
| 404 |       Not Found       |       1000 |
| 500 | Internal Server Error |        500 |
```

## 3. Нефункциональные требования

- Код должен быть написан ясно и структурировано в соответствии с требованиями,
  указанными в разделе "Требования к ДЗ" информационного блока.
- Программа должна компилироваться и запускаться.
- Программа должна придерживаться fail-fast поведения.
- Программа должна обрабатывать лог-файлы эффективно, не загружая весь файл в память
- Программа должна логировать все важные события, которые происходят во время ее работы.
    - Логирование должно осуществляться в stdout.
    - Для логирования необходимо использовать `log4j` (подключен в шаблоне).
- В случае возникновения ошибок, в зависимости от их критичности, программа либо должна завершать свою работу,
  либо логировать факт возникновения подобного рода ситуации.
- Результат работы программы должен быть легко интерпретируемым человеком.
- Программа должна быть покрыта юнит-тестами. Минимальный уровень покрытия - **50%**.
    - Необходимо реализовать все стабы acceptance-тестов (тесты в пакете `acceptance`).
    - Каждый компонент программы должен быть легко-тестируем.
    - [Подробнее про тестирование тут](./TESTS.md).
- Программа проходит blackbox-тесты ([подробнее тут](./TESTS.md)).
- По возможности небходимо использовать готовые библиотеки для решения поставленных задач.
- В комментарии к MR должно быть дано краткое описание того, что было реализовано,
  а так же примеры работы вашей программы.
